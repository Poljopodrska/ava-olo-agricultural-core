<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AVA OLO - Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo h1 {
            color: #2c5530;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .status-connected {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .status-disconnected {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .dashboard {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .metric-title {
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .icon-farmers { background: linear-gradient(135deg, #60a5fa, #3b82f6); }
        .icon-fields { background: linear-gradient(135deg, #34d399, #10b981); }
        .icon-crops { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
        .icon-conversations { background: linear-gradient(135deg, #a78bfa, #8b5cf6); }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1f2937;
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .metric-change {
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .change-positive { color: #16a34a; }
        .change-negative { color: #dc2626; }
        .change-neutral { color: #6b7280; }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .activity-feed {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }

        .activity-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activity-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .refresh-btn:hover {
            opacity: 0.8;
        }

        .activity-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: background-color 0.3s ease;
        }

        .activity-item:hover {
            background: rgba(0,0,0,0.02);
        }

        .activity-icon {
            width: 35px;
            height: 35px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
        }

        .activity-conversation { background: #8b5cf6; }
        .activity-field { background: #10b981; }
        .activity-task { background: #f59e0b; }

        .activity-content {
            flex: 1;
        }

        .activity-description {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .activity-meta {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .dashboard {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <div style="font-size: 2rem;">üåæ</div>
            <h1>AVA OLO Dashboard</h1>
        </div>
        <div id="connectionStatus" class="connection-status status-disconnected">
            <div class="status-indicator"></div>
            <span>Spajanje...</span>
        </div>
    </div>

    <div class="dashboard">
        <!-- Key Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">Ukupno Farmi</div>
                    <div class="metric-icon icon-farmers">üë®‚Äçüåæ</div>
                </div>
                <div class="metric-value" id="totalFarmers">-</div>
                <div class="metric-change change-positive" id="farmersChange">
                    <span>üìà</span> Uƒçitavanje...
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">Aktivna Polja</div>
                    <div class="metric-icon icon-fields">üåø</div>
                </div>
                <div class="metric-value" id="totalFields">-</div>
                <div class="metric-change change-positive" id="fieldsChange">
                    <span>üìà</span> Uƒçitavanje...
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">Aktivni Usjevi</div>
                    <div class="metric-icon icon-crops">üåΩ</div>
                </div>
                <div class="metric-value" id="activeCrops">-</div>
                <div class="metric-change change-positive" id="cropsChange">
                    <span>üìà</span> Uƒçitavanje...
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">Razgovori</div>
                    <div class="metric-icon icon-conversations">üí¨</div>
                </div>
                <div class="metric-value" id="totalConversations">-</div>
                <div class="metric-change change-positive" id="conversationsChange">
                    <span>üìà</span> Uƒçitavanje...
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-title">Rast Farmi (30 dana)</div>
                <div class="chart-container">
                    <canvas id="growthChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title">Distribucija po Tipovima Usjeva</div>
                <div class="chart-container">
                    <canvas id="cropChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Activity Feed -->
        <div class="activity-feed">
            <div class="activity-header">
                <div class="activity-title">Najnovije Aktivnosti</div>
                <button class="refresh-btn" onclick="loadActivityFeed()">Osvje≈æi</button>
            </div>
            <div class="activity-list" id="activityList">
                <div class="loading">Uƒçitavanje aktivnosti...</div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:8010/api';
        let websocket = null;
        let charts = {};

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            setupWebSocket();
            
            // Auto-refresh every 30 seconds
            setInterval(loadOverviewStats, 30000);
            setInterval(loadActivityFeed, 60000);
        });

        async function initializeDashboard() {
            try {
                updateConnectionStatus('connected');
                await Promise.all([
                    loadOverviewStats(),
                    loadGrowthTrends(),
                    loadGrowthChart(),
                    loadCropDistribution(),
                    loadActivityFeed()
                ]);
            } catch (error) {
                console.error('Dashboard initialization error:', error);
                updateConnectionStatus('disconnected');
                showError('Gre≈°ka pri uƒçitavanju dashboard-a: ' + error.message);
            }
        }

        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            const isConnected = status === 'connected';
            
            statusEl.className = `connection-status ${isConnected ? 'status-connected' : 'status-disconnected'}`;
            statusEl.querySelector('span').textContent = isConnected ? 'Spojeno' : 'Nema veze';
        }

        async function apiRequest(endpoint) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`API request failed for ${endpoint}:`, error);
                throw error;
            }
        }

        async function loadOverviewStats() {
            try {
                const data = await apiRequest('/stats/overview');
                
                // Update metric cards
                document.getElementById('totalFarmers').textContent = data.total_farmers || 0;
                document.getElementById('totalFields').textContent = data.total_fields || 0;
                document.getElementById('activeCrops').textContent = data.active_crops || 0;
                document.getElementById('totalConversations').textContent = data.total_conversations || 0;
                
                // Update trends
                const trends = await apiRequest('/stats/growth-trends');
                
                updateMetricChange('farmersChange', trends.new_farmers_24h, 'nove farme danas');
                updateMetricChange('fieldsChange', trends.new_fields_24h, 'nova polja danas');
                updateMetricChange('cropsChange', trends.growth_rate_daily.toFixed(1), '% dnevni rast');
                updateMetricChange('conversationsChange', trends.new_farmers_7d, 'novi korisnici ovaj tjedan');
                
            } catch (error) {
                showError('Gre≈°ka pri uƒçitavanju osnovnih statistika');
            }
        }

        function updateMetricChange(elementId, value, label) {
            const element = document.getElementById(elementId);
            const isPositive = value > 0;
            const icon = isPositive ? 'üìà' : (value < 0 ? 'üìâ' : '‚ûñ');
            
            element.className = `metric-change ${isPositive ? 'change-positive' : (value < 0 ? 'change-negative' : 'change-neutral')}`;
            element.innerHTML = `<span>${icon}</span> ${value} ${label}`;
        }

        async function loadGrowthChart() {
            try {
                const data = await apiRequest('/stats/growth-chart?period=30');
                
                const ctx = document.getElementById('growthChart').getContext('2d');
                
                if (charts.growthChart) {
                    charts.growthChart.destroy();
                }

                charts.growthChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => new Date(d.date).toLocaleDateString('hr-HR')),
                        datasets: [
                            {
                                label: 'Kumulativne Farme',
                                data: data.map(d => d.cumulative_farmers),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Nova Polja',
                                data: data.map(d => d.new_fields),
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                fill: false,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                
            } catch (error) {
                showError('Gre≈°ka pri uƒçitavanju grafikona rasta');
            }
        }

        async function loadCropDistribution() {
            try {
                const data = await apiRequest('/stats/overview');
                const cropData = data.hectares_by_crop || {};
                
                const ctx = document.getElementById('cropChart').getContext('2d');
                
                if (charts.cropChart) {
                    charts.cropChart.destroy();
                }

                const labels = Object.keys(cropData);
                const values = Object.values(cropData);
                
                charts.cropChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: [
                                '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6',
                                '#ef4444', '#06b6d4', '#84cc16', '#f97316'
                            ],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                            }
                        }
                    }
                });
                
            } catch (error) {
                showError('Gre≈°ka pri uƒçitavanju distribucije usjeva');
            }
        }

        async function loadActivityFeed() {
            try {
                const data = await apiRequest('/activity/live-feed');
                const activityList = document.getElementById('activityList');
                
                if (data.length === 0) {
                    activityList.innerHTML = '<div class="loading">Nema aktivnosti</div>';
                    return;
                }
                
                activityList.innerHTML = data.map(activity => {
                    const iconClass = getActivityIconClass(activity.activity_type);
                    const timeStr = new Date(activity.timestamp).toLocaleString('hr-HR');
                    
                    return `
                        <div class="activity-item">
                            <div class="activity-icon ${iconClass}">
                                ${getActivityIcon(activity.activity_type)}
                            </div>
                            <div class="activity-content">
                                <div class="activity-description">${activity.description}</div>
                                <div class="activity-meta">
                                    ${activity.farmer_name || 'Nepoznat korisnik'} ‚Ä¢ ${timeStr}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                document.getElementById('activityList').innerHTML = 
                    '<div class="error">Gre≈°ka pri uƒçitavanju aktivnosti</div>';
            }
        }

        function getActivityIconClass(type) {
            const typeMap = {
                'conversation': 'activity-conversation',
                'field_created': 'activity-field',
                'task_logged': 'activity-task'
            };
            return typeMap[type] || 'activity-conversation';
        }

        function getActivityIcon(type) {
            const iconMap = {
                'conversation': 'üí¨',
                'field_created': 'üåø',
                'task_logged': 'üìã'
            };
            return iconMap[type] || 'üìã';
        }

        function setupWebSocket() {
            try {
                websocket = new WebSocket('ws://localhost:8010/ws');
                
                websocket.onopen = function(event) {
                    console.log('WebSocket connected');
                    updateConnectionStatus('connected');
                };
                
                websocket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'stats_update') {
                            // Handle real-time updates
                            console.log('Real-time update:', data.data);
                            // You could update specific metrics here
                        }
                    } catch (error) {
                        console.error('WebSocket message parsing error:', error);
                    }
                };
                
                websocket.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    updateConnectionStatus('disconnected');
                };
                
                websocket.onclose = function(event) {
                    console.log('WebSocket disconnected');
                    updateConnectionStatus('disconnected');
                    
                    // Reconnect after 5 seconds
                    setTimeout(setupWebSocket, 5000);
                };
                
            } catch (error) {
                console.error('WebSocket setup error:', error);
                updateConnectionStatus('disconnected');
            }
        }

        function showError(message) {
            // You could implement a toast notification system here
            console.error(message);
        }

        // Utility function for Croatian locale formatting
        function formatNumber(num) {
            return new Intl.NumberFormat('hr-HR').format(num);
        }
    </script>
</body>
</html>